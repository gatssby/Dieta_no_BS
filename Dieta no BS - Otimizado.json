{
  "name": "Dieta no BS - Otimizado",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "dieta-ios",
        "responseMode": "responseNode",
        "options": {
          "responseHeaders": {
            "entries": [
              {
                "name": "Content-Type",
                "value": "application/json"
              }
            ]
          }
        }
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2.1,
      "position": [
        -352,
        816
      ],
      "id": "02cf0811-e2a1-45c7-a02e-76a8c48e5dc1",
      "name": "Webhook iOS",
      "webhookId": "f710b7d7-4eba-4227-ac60-df7753766043"
    },
    {
      "parameters": {
        "jsCode": "// ValidaÃ§Ã£o e normalizaÃ§Ã£o do input\nconst body = $input.item.json.body;\n\n// 1. VerificaÃ§Ã£o bÃ¡sica\nif (!body || !body.choice) {\n  throw new Error('âŒ RequisiÃ§Ã£o invÃ¡lida: campo \"choice\" ausente');\n}\n\nconst rawChoice = body.choice.trim();\nconst text = (body.text || '').trim();\nconst combo = (body.combo || '').trim();\n\n// --- VALIDAÃ‡Ã•ES ESPECÃFICAS ---\n\n// 1. LOGAR (Unificado)\n// Verifica se a escolha comeÃ§a com \"Logar\" (cobre \"Logar\", \"Logar (TBCA)\" e \"Logar (Manual)\")\nif (rawChoice.startsWith('Logar') && !text) {\n  throw new Error('âŒ Campo \"text\" obrigatÃ³rio para registrar alimento');\n}\n\n// 2. SOLVER\nif (rawChoice === 'Solver' && !combo) {\n  throw new Error('âŒ Campo \"combo\" obrigatÃ³rio para Solver');\n}\n\n// 3. RESUMO E LIMPEZA\n// Passam direto sem validaÃ§Ã£o extra\nif (['Resumo do dia', 'Limpar'].includes(rawChoice)) {\n    // Tudo certo\n}\n\n// --- NORMALIZAÃ‡ÃƒO PARA O PRÃ“XIMO PASSO ---\n// Aqui garantimos que o Router receba sempre \"Logar\" limpo,\n// independente do que veio do iPhone\nlet finalChoice = rawChoice;\nif (rawChoice.startsWith('Logar')) {\n    finalChoice = 'Logar';\n}\n\nreturn {\n  json: {\n    choice: finalChoice, // Entrega sempre \"Logar\", \"Solver\" ou \"Resumo do dia\"\n    text,\n    combo,\n    timestamp: new Date().toISOString()\n  }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -128,
        816
      ],
      "id": "04b3ac33-2202-457c-9aa7-e275492d63f9",
      "name": "Validador de Input"
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 3
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.choice }}",
                    "rightValue": "Logar",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "48151947-d667-402e-958f-c56f415fca19"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Logar"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 3
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.choice }}",
                    "rightValue": "Solver",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "1e1a210b-0963-4dc0-9195-aeae2f7ca9fb"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Solver"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 3
                },
                "conditions": [
                  {
                    "id": "a6bae403-1fe1-4b83-a029-fa7d2c1ee97b",
                    "leftValue": "={{ $json.choice }}",
                    "rightValue": "Limpar",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Limpar"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 3
                },
                "conditions": [
                  {
                    "id": "9068c81a-456c-4ce9-930e-06f05e57e3cf",
                    "leftValue": "={{ $json.choice }}",
                    "rightValue": "Resumo do dia",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Resumo"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.4,
      "position": [
        96,
        784
      ],
      "id": "e0377a0d-c6ce-4c66-981d-2111200e06f0",
      "name": "Router Principal"
    },
    {
      "parameters": {
        "authentication": "serviceAccount",
        "documentId": {
          "__rl": true,
          "value": "1yVp7WvIQWs84o_VtvOscupn_dzC-L0B65cLnX2J4MKk",
          "mode": "list",
          "cachedResultName": "Dieta no BS"
        },
        "sheetName": {
          "__rl": true,
          "value": 2115030679,
          "mode": "list",
          "cachedResultName": "DB tbca"
        },
        "options": {
          "dataLocationOnSheet": {
            "values": {
              "rangeDefinition": "detectAutomatically",
              "readRowsUntil": "firstEmptyRow"
            }
          }
        }
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        544,
        432
      ],
      "id": "18c412cc-8549-44dc-8c7e-fed9d6f242d9",
      "name": "Ler DB Alimentos",
      "credentials": {
        "googleApi": {
          "id": "eERTLBwvloLmxnxp",
          "name": "GSheets - Service Account"
        }
      }
    },
    {
      "parameters": {
        "modelId": {
          "__rl": true,
          "value": "gpt-4o-mini",
          "mode": "list"
        },
        "responses": {
          "values": [
            {
              "content": "=VocÃª Ã© um extrator de dados numÃ©ricos preciso.\n\nCONTEXTO:\nUm algoritmo jÃ¡ identificou que o alimento consumido foi \"{{ $json.match_name }}\".\nO usuÃ¡rio digitou o texto: \"{{ $json.original }}\".\n\nSUA TAREFA:\n1. Ignore o nome do alimento que o usuÃ¡rio digitou. Use APENAS o \"{{ $json.match_name }}\".\n2. Analise o texto do usuÃ¡rio APENAS para extrair a Quantidade e Unidade.\n3. Se nÃ£o houver quantidade, assuma 100g.\n\nRESPOSTA JSON:\n{\n  \"alimento\": \"{{ $json.match_name }}\",\n  \"quantidade\": 0,\n  \"unidade\": \"g\",\n  \"confianca\": 1\n}"
            }
          ]
        },
        "builtInTools": {},
        "options": {
          "maxTokens": 200,
          "textFormat": {
            "textOptions": {
              "type": "json_object"
            }
          },
          "temperature": 0.1
        }
      },
      "type": "@n8n/n8n-nodes-langchain.openAi",
      "typeVersion": 2.1,
      "position": [
        1216,
        336
      ],
      "id": "e9df198e-e716-4f2e-841f-eab94a7b92b0",
      "name": "IA TBCA",
      "credentials": {
        "openAiApi": {
          "id": "ovGwLx8HCyamhkCw",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Parse e validaÃ§Ã£o da resposta da IA\nconst rawResponse = $input.item.json.output[0].content[0].text;\n\nlet parsed;\ntry {\n  parsed = typeof rawResponse === 'string' ? JSON.parse(rawResponse) : rawResponse;\n} catch (e) {\n  throw new Error('âŒ Resposta da IA invÃ¡lida: ' + e.message);\n}\n\n// ValidaÃ§Ã£o de erro\nif (parsed.erro) {\n  throw new Error('âŒ ' + parsed.erro);\n}\n\n// ValidaÃ§Ã£o de campos obrigatÃ³rios\nif (!parsed.alimento || !parsed.quantidade) {\n  throw new Error('âŒ Resposta incompleta da IA');\n}\n\n// NormalizaÃ§Ã£o\nreturn {\n  json: {\n    alimento: parsed.alimento.trim(),\n    quantidade: Number(parsed.quantidade),\n    unidade: parsed.unidade || 'g',\n    confianca: parsed.confianca || 1.0,\n    timestamp: new Date().toISOString()\n  }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1568,
        336
      ],
      "id": "56924351-2246-4812-9e93-6684fdad6506",
      "name": "Validar Resposta TBCA"
    },
    {
      "parameters": {
        "authentication": "serviceAccount",
        "operation": "append",
        "documentId": {
          "__rl": true,
          "value": "1yVp7WvIQWs84o_VtvOscupn_dzC-L0B65cLnX2J4MKk",
          "mode": "list"
        },
        "sheetName": {
          "__rl": true,
          "value": 828175543,
          "mode": "list",
          "cachedResultName": "LOG_TBCA"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "Alimento": "={{ $json.alimento }}",
            "Quantidade": "={{ $json.quantidade }}"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "Alimento",
              "displayName": "Alimento",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "Quantidade",
              "displayName": "Quantidade",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        1792,
        336
      ],
      "id": "4e257fb9-4483-499e-83a9-320d2b459209",
      "name": "Gravar TBCA",
      "credentials": {
        "googleApi": {
          "id": "eERTLBwvloLmxnxp",
          "name": "GSheets - Service Account"
        }
      }
    },
    {
      "parameters": {
        "modelId": {
          "__rl": true,
          "value": "gpt-4o-mini",
          "mode": "list"
        },
        "responses": {
          "values": [
            {
              "content": "=VocÃª Ã© um nutricionista brasileiro especializado na tabela TBCA (Tabela Brasileira de ComposiÃ§Ã£o de Alimentos).\n\n**INPUT:** \"{{ $json.original }}\"\n\n**TAREFA:**\nAnalise o input e calcule os macronutrientes TOTAIS da refeiÃ§Ã£o.\n\n**HIERARQUIA DE DADOS:**\n1. **DADOS EXPLÃCITOS:** Se o usuÃ¡rio informou os macros (ex: \"30p\"), use exatamente.\n2. **TBCA:** Use dados oficiais. Prefira alimentos preparados/cozidos (ex: \"ovo frito\" em vez de cru).\n\n**REGRAS CRITICAS DE QUANTIDADE:**\n1. **RESPEITE A UNIDADE DO USUÃRIO:** Se o usuÃ¡rio disser \"2 ovos\", o campo \"quantidade\" DEVE ser \"2 unidades\" (ou \"2 ovos\"). NÃƒO converta para \"100g\" no texto de saÃ­da, apenas use o peso para o cÃ¡lculo matemÃ¡tico dos macros.\n2. **PADRÃƒO:** Apenas se o usuÃ¡rio nÃ£o informar nada (ex: \"pÃ£o\"), assuma 1 unidade padrÃ£o ou 100g.\n\n**FORMATO DE RESPOSTA (JSON puro):**\n{\n  \"alimento\": \"Nome do alimento (ex: Ovo Frito)\",\n  \"quantidade\": \"Texto fiel ao input (ex: 2 unidades)\",\n  \"proteina\": 0.0,\n  \"carboidrato\": 0.0,\n  \"gordura\": 0.0,\n  \"calorias\": 0,\n  \"fonte\": \"TBCA\"\n}"
            }
          ]
        },
        "simplify": false,
        "builtInTools": {},
        "options": {
          "maxTokens": 300,
          "textFormat": {
            "textOptions": {
              "type": "json_object"
            }
          },
          "temperature": 0.2
        }
      },
      "type": "@n8n/n8n-nodes-langchain.openAi",
      "typeVersion": 2.1,
      "position": [
        1216,
        528
      ],
      "id": "c4253908-5ea2-47ae-8129-c675596f54d4",
      "name": "IA Manual",
      "credentials": {
        "openAiApi": {
          "id": "ovGwLx8HCyamhkCw",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// 1. Pega o conteÃºdo bruto da resposta da IA\nconst rawContent = $input.item.json.output[0].content[0].text;\n\n// 2. PARSE SEGURO (A proteÃ§Ã£o extra)\n// Verifica se veio como texto e converte para Objeto JSON se necessÃ¡rio\nlet dados;\ntry {\n  dados = typeof rawContent === 'string' ? JSON.parse(rawContent) : rawContent;\n} catch (e) {\n  throw new Error('âŒ A IA nÃ£o retornou um JSON vÃ¡lido: ' + e.message);\n}\n\n// 3. ValidaÃ§Ã£o de seguranÃ§a (Garante que os campos existem)\nif (!dados.alimento || !dados.quantidade) {\n    throw new Error('âŒ IA retornou dados incompletos.');\n}\n\n// 4. FunÃ§Ãµes de FormataÃ§Ã£o (Mantive as suas)\nconst numBR = (v) => {\n  if (v === undefined || v === null) return \"0,0\";\n  return String(v).replace('.', ',');\n};\n\nconst txtBR = (t) => {\n  if (!t) return \"\";\n  const s = String(t).trim();\n  return s.charAt(0).toUpperCase() + s.slice(1);\n};\n\n// 5. Retorno Final\nreturn {\n  json: {\n    alimento: txtBR(dados.alimento),\n    quantidade: txtBR(dados.quantidade),\n    \n    // Macros formatados\n    proteina: numBR(dados.proteina),\n    carboidrato: numBR(dados.carboidrato),\n    gordura: numBR(dados.gordura),\n    \n    // Extras\n    calorias: dados.calorias || 0,\n    fonte: dados.fonte || 'estimado',\n    timestamp: new Date().toISOString()\n  }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1568,
        528
      ],
      "id": "a8cc2c62-eb20-4ab9-8009-6866566ab726",
      "name": "Validar Manual"
    },
    {
      "parameters": {
        "authentication": "serviceAccount",
        "operation": "append",
        "documentId": {
          "__rl": true,
          "value": "=1yVp7WvIQWs84o_VtvOscupn_dzC-L0B65cLnX2J4MKk",
          "mode": "id"
        },
        "sheetName": {
          "__rl": true,
          "value": 2117294695,
          "mode": "list",
          "cachedResultName": "LOG_MANUAL",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1yVp7WvIQWs84o_VtvOscupn_dzC-L0B65cLnX2J4MKk/edit#gid=2117294695"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "Alimento": "={{ $json.alimento }}",
            "Quantidade": "={{ $json.quantidade }}",
            "Prot": "={{ $json.proteina }}",
            "Carb": "={{ $json.carboidrato }}",
            "Gord": "={{ $json.gordura }}"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "Alimento",
              "displayName": "Alimento",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "Quantidade",
              "displayName": "Quantidade",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "Prot",
              "displayName": "Prot",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "Carb",
              "displayName": "Carb",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "Gord",
              "displayName": "Gord",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        1792,
        528
      ],
      "id": "3533d382-b68b-4fa1-bd3a-12a7a8e3fa8a",
      "name": "Gravar Manual",
      "credentials": {
        "googleApi": {
          "id": "eERTLBwvloLmxnxp",
          "name": "GSheets - Service Account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Parse do combo vindo do Validador\n// Ex esperado: \"Arroz + Frango\"\nconst combo = $('Validador de Input').item.json.combo;\nconst partes = combo.split('+').map(p => p.trim());\n\n// ValidaÃ§Ã£o de seguranÃ§a\nif (partes.length !== 2) {\n  throw new Error(`âŒ Formato invÃ¡lido recebido: \"${combo}\". O padrÃ£o deve ser \"Carbo + ProteÃ­na\"`);\n}\n\nconst [carboInput, protInput] = partes;\n\n// --- REGRA DE TRADUÃ‡ÃƒO ---\n// Apenas as proteÃ­nas precisam de \"traduÃ§Ã£o\" para o nome oficial do DB.\n// Os carboidratos (Arroz, Batata Inglesa, MacarrÃ£o) passarÃ£o exatamente como vieram.\nconst MAPA_PROTEINA = {\n  'Frango': 'Peito de Frango',\n  'Patinho': 'Patinho Grelhado'\n};\n\n// Aplica a traduÃ§Ã£o (ou mantÃ©m o original se nÃ£o estiver no mapa)\nconst proteinaOficial = MAPA_PROTEINA[protInput] || protInput;\nconst carboOficial = carboInput; \n\nreturn {\n  json: {\n    proteina: proteinaOficial,\n    carboidrato: carboOficial,\n    combo_original: combo,\n    timestamp: new Date().toISOString()\n  }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        320,
        720
      ],
      "id": "f9454f6c-61a0-4100-8a7e-a91bd17d9310",
      "name": "Tradutor Combo"
    },
    {
      "parameters": {
        "authentication": "serviceAccount",
        "operation": "update",
        "documentId": {
          "__rl": true,
          "value": "1yVp7WvIQWs84o_VtvOscupn_dzC-L0B65cLnX2J4MKk",
          "mode": "list"
        },
        "sheetName": {
          "__rl": true,
          "value": 1378726331,
          "mode": "list",
          "cachedResultName": "SOLVER_AUTO"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "INPUT CARBO": "={{ $json.carboidrato }}",
            "row_number": 2,
            "INPUT PROT": "={{ $json.proteina }}"
          },
          "matchingColumns": [
            "row_number"
          ],
          "schema": [
            {
              "id": "INPUT PROT",
              "displayName": "INPUT PROT",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "INPUT CARBO",
              "displayName": "INPUT CARBO",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "FALTA PROT",
              "displayName": "FALTA PROT",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "FALTA KCAL",
              "displayName": "FALTA KCAL",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "RESULTADO PROT (g)",
              "displayName": "RESULTADO PROT (g)",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "HELPER (Kcal da Prot)",
              "displayName": "HELPER (Kcal da Prot)",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "RESULTADO CARBO (g)",
              "displayName": "RESULTADO CARBO (g)",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "TOTAL KCAL",
              "displayName": "TOTAL KCAL",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "row_number",
              "displayName": "row_number",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true,
              "readOnly": true,
              "removed": true
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        544,
        720
      ],
      "id": "fa8fdd3f-69df-4df5-88b8-c3a3080feb7a",
      "name": "Atualizar Solver",
      "credentials": {
        "googleApi": {
          "id": "eERTLBwvloLmxnxp",
          "name": "GSheets - Service Account"
        }
      }
    },
    {
      "parameters": {
        "authentication": "serviceAccount",
        "documentId": {
          "__rl": true,
          "value": "1yVp7WvIQWs84o_VtvOscupn_dzC-L0B65cLnX2J4MKk",
          "mode": "list"
        },
        "sheetName": {
          "__rl": true,
          "value": 1378726331,
          "mode": "list",
          "cachedResultName": "SOLVER_AUTO"
        },
        "options": {
          "dataLocationOnSheet": {
            "values": {
              "rangeDefinition": "specifyRangeA1",
              "range": "A1:H2"
            }
          }
        }
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        768,
        720
      ],
      "id": "9b546243-a1ee-45cf-9ed8-8c4977e7d810",
      "name": "Ler Resultado Solver",
      "credentials": {
        "googleApi": {
          "id": "eERTLBwvloLmxnxp",
          "name": "GSheets - Service Account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const item = $input.first().json;\n\n// FunÃ§Ã£o de seguranÃ§a para pegar texto limpo\nfunction pegar(nomeColuna) {\n  const valor = item[nomeColuna];\n  if (!valor) return \"---\";\n  return String(valor).trim();\n}\n\n// Prepara os nÃºmeros (arredondando)\nconst qtdProt = Math.round(Number(item[\"RESULTADO PROT (g)\"]) || 0);\nconst qtdCarbo = Math.round(Number(item[\"RESULTADO CARBO (g)\"]) || 0);\nconst totalKcal = Math.round(Number(item[\"TOTAL KCAL\"]) || 0);\n\n// SEU LAYOUT NOVO:\nconst textoFinal = \n`ðŸ½ï¸ DIETA CALCULADA\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\nðŸ¥© PROTEÃNA: ${pegar(\"INPUT PROT\")}\n   â””â”€ Consumir: ${qtdProt}g\n\nðŸš CARBOIDRATO: ${pegar(\"INPUT CARBO\")}\n   â””â”€ Consumir: ${qtdCarbo}g\n\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\nâš¡ TOTAL: ${totalKcal} kcal\n\nâœ… CÃ¡lculo realizado com sucesso!`;\n\nreturn {\n  json: {\n    meu_texto: textoFinal\n  }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        992,
        720
      ],
      "id": "c66dbdac-9893-4cae-93e2-dbdf659d6632",
      "name": "Formatar Resposta"
    },
    {
      "parameters": {
        "authentication": "serviceAccount",
        "operation": "clear",
        "documentId": {
          "__rl": true,
          "value": "1yVp7WvIQWs84o_VtvOscupn_dzC-L0B65cLnX2J4MKk",
          "mode": "list",
          "cachedResultName": "Dieta no BS",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1yVp7WvIQWs84o_VtvOscupn_dzC-L0B65cLnX2J4MKk/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": 2117294695,
          "mode": "list",
          "cachedResultName": "LOG_MANUAL",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1yVp7WvIQWs84o_VtvOscupn_dzC-L0B65cLnX2J4MKk/edit#gid=2117294695"
        },
        "clear": "specificRange",
        "range": "A2:E23"
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        544,
        1104
      ],
      "id": "7427730b-76dc-4c63-8b24-6dbf0cb4b754",
      "name": "Limpar Log Manual",
      "credentials": {
        "googleApi": {
          "id": "eERTLBwvloLmxnxp",
          "name": "GSheets - Service Account"
        }
      }
    },
    {
      "parameters": {
        "authentication": "serviceAccount",
        "operation": "clear",
        "documentId": {
          "__rl": true,
          "value": "1yVp7WvIQWs84o_VtvOscupn_dzC-L0B65cLnX2J4MKk",
          "mode": "list"
        },
        "sheetName": {
          "__rl": true,
          "value": 828175543,
          "mode": "list",
          "cachedResultName": "LOG_TBCA"
        },
        "clear": "specificRows",
        "startIndex": 2,
        "rowsToDelete": 20
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        768,
        1104
      ],
      "id": "471dae2c-6e32-4680-b90f-5e4a89ce0c36",
      "name": "Limpar Log TBCA",
      "credentials": {
        "googleApi": {
          "id": "eERTLBwvloLmxnxp",
          "name": "GSheets - Service Account"
        }
      }
    },
    {
      "parameters": {
        "authentication": "serviceAccount",
        "operation": "clear",
        "documentId": {
          "__rl": true,
          "value": "1yVp7WvIQWs84o_VtvOscupn_dzC-L0B65cLnX2J4MKk",
          "mode": "list"
        },
        "sheetName": {
          "__rl": true,
          "value": "HOJE",
          "mode": "name"
        },
        "clear": "specificRange",
        "range": "A9:E28"
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        992,
        1104
      ],
      "id": "4e772a6c-ea9a-410b-ac04-5e43185dc0ef",
      "name": "Limpar Dashboard",
      "credentials": {
        "googleApi": {
          "id": "eERTLBwvloLmxnxp",
          "name": "GSheets - Service Account"
        }
      }
    },
    {
      "parameters": {
        "respondWith": "text",
        "responseBody": "={{ $json.meu_texto }}",
        "options": {
          "responseCode": 200
        }
      },
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.5,
      "position": [
        1280,
        816
      ],
      "id": "c3894a72-c3d9-494b-8af2-7c490b7a68fb",
      "name": "Responder",
      "alwaysOutputData": true
    },
    {
      "parameters": {
        "authentication": "serviceAccount",
        "documentId": {
          "__rl": true,
          "value": "1yVp7WvIQWs84o_VtvOscupn_dzC-L0B65cLnX2J4MKk",
          "mode": "list",
          "cachedResultName": "Dieta no BS",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1yVp7WvIQWs84o_VtvOscupn_dzC-L0B65cLnX2J4MKk/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": 1017477946,
          "mode": "list",
          "cachedResultName": "Resumo_do_dia",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1yVp7WvIQWs84o_VtvOscupn_dzC-L0B65cLnX2J4MKk/edit#gid=1017477946"
        },
        "options": {
          "dataLocationOnSheet": {
            "values": {
              "rangeDefinition": "detectAutomatically",
              "readRowsUntil": "firstEmptyRow"
            }
          },
          "returnFirstMatch": false
        }
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        768,
        912
      ],
      "id": "13055c1e-cc9b-498f-8dd7-e47e6c3bffd7",
      "name": "Get row(s) in sheet",
      "credentials": {
        "googleApi": {
          "id": "eERTLBwvloLmxnxp",
          "name": "GSheets - Service Account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Pega todos os itens lidos da planilha\nconst items = $input.all();\n\n// Inicializa variÃ¡veis\nlet listaPratos = \"\";\nlet totalP = 0;\nlet totalC = 0;\nlet totalG = 0;\nlet totalCal = 0;\nlet itensValidos = 0; // Contador de itens reais\n\n// FunÃ§Ã£o auxiliar para garantir nÃºmeros\nconst n = (val) => {\n  if (typeof val === 'number') return val;\n  // Trata vazio como 0 e troca vÃ­rgula por ponto\n  if (!val || val.toString().trim() === \"\") return 0;\n  return parseFloat(String(val).replace(',', '.')) || 0;\n};\n\n// Loop para montar a lista e somar\nfor (const item of items) {\n  const json = item.json;\n  \n  // --- A CORREÃ‡ÃƒO ESTÃ AQUI ---\n  // 1. Converte para string\n  // 2. .trim() remove todos os espaÃ§os em branco do inÃ­cio e fim\n  const nomeAlimento = String(json.Alimento || \"\").trim();\n\n  // Se o nome estiver vazio (apÃ³s remover espaÃ§os), pula esta linha\n  if (!nomeAlimento) {\n    continue; \n  }\n\n  // Se chegou aqui, Ã© um item vÃ¡lido\n  itensValidos++;\n\n  // Adiciona na lista visual (Usando o nome limpo)\n  listaPratos += `â–ªï¸ ${nomeAlimento} (${json.Quantidade})\\n`;\n  \n  // Soma os macros\n  totalP += n(json.Prot);\n  totalC += n(json.Carb);\n  totalG += n(json.Gord);\n  totalCal += n(json.Calorias);\n}\n\n// --- VERIFICAÃ‡ÃƒO FINAL ---\n// Se apÃ³s limpar a sujeira nÃ£o sobrou nenhum item vÃ¡lido:\nif (itensValidos === 0) {\n  return { \n    json: { \n      meu_texto: \"ðŸ½ï¸ *Resumo do Dia:*\\n\\nAinda nÃ£o hÃ¡ nada gravado na lista de hoje.\" \n    } \n  };\n}\n\n// FormataÃ§Ã£o final dos nÃºmeros\nconst pFinal = totalP.toFixed(1).replace('.', ',');\nconst cFinal = totalC.toFixed(1).replace('.', ',');\nconst gFinal = totalG.toFixed(1).replace('.', ',');\nconst calFinal = Math.round(totalCal);\n\n// Montagem do Layout Final\nconst textoFinal = \n`ðŸ½ï¸ RESUMO DO DIA\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n${listaPratos}\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\nðŸ¥© PROTEÃNA: ${pFinal}g\nðŸš CARBOIDRATO: ${cFinal}g\nðŸ¥‘ GORDURA: ${gFinal}g\n\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\nâš¡ CALORIAS TOTAIS: ${calFinal} kcal`;\n\n// Retorna o resultado\nreturn {\n  json: {\n    meu_texto: textoFinal\n  }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        992,
        912
      ],
      "id": "e98d46ac-0cd2-4b02-b113-cb72572fc208",
      "name": "Formatar resumo"
    },
    {
      "parameters": {
        "jsCode": "// --- CONFIGURAÃ‡Ã•ES ---\nconst THRESHOLD = 0.55; // Grau de exigÃªncia da similaridade (0 a 1)\n\n// 1. Pega o input do usuÃ¡rio vindo do Validador\n// Importante: Certifique-se que o node anterior se chama 'Validador de Input' ou ajuste aqui\nconst inputFull = $('Validador de Input').item.json.text || \"\";\n\n// LIMPEZA (Regex)\n// Remove pesos e medidas para comparar apenas o texto (ex: \"Frango 100g\" vira \"Frango\")\nconst cleanInput = inputFull\n  .replace(/[0-9]+([.,][0-9]+)?\\s*(g|ml|kg|l|un|xic|col|sopa|fatia)?/gi, '')\n  .trim();\n\n// 2. BUSCA NO BANCO DE DADOS\nconst allItems = $input.all();\n\n// DiagnÃ³stico de Coluna: Procura automaticamente a coluna certa\n// No seu arquivo 'Dieta no BS.xlsx', a coluna Ã© \"Nome do Alimento\"\nconst primeiroItem = allItems[0] ? allItems[0].json : {};\nconst chaves = Object.keys(primeiroItem);\n\nconst nomeColuna = chaves.find(key => \n  key.toLowerCase().includes(\"nome do alimento\") || \n  key.toLowerCase().includes(\"alimento\")\n);\n\nif (!nomeColuna) {\n  return {\n    json: {\n      erro: \"Coluna de nome nÃ£o encontrada na planilha DB tbca\",\n      chaves_disponiveis: chaves\n    }\n  };\n}\n\n// Cria a lista limpa para comparaÃ§Ã£o\nconst dbItems = allItems.map(i => i.json[nomeColuna]).filter(i => i);\n\n// 3. ALGORITMO DE SIMILARIDADE (Dice Coefficient)\nfunction getSimilarity(s1, s2) {\n  if (!s1 || !s2) return 0;\n  let first = s1.replace(/\\s+/g, '').toLowerCase();\n  let second = s2.replace(/\\s+/g, '').toLowerCase();\n\n  if (first === second) return 1;\n  if (first.length < 2 || second.length < 2) return 0;\n\n  let bigrams = new Map();\n  for (let i = 0; i < first.length - 1; i++) {\n    const bigram = first.substring(i, i + 2);\n    const count = bigrams.has(bigram) ? bigrams.get(bigram) + 1 : 1;\n    bigrams.set(bigram, count);\n  }\n  let intersection = 0;\n  for (let i = 0; i < second.length - 1; i++) {\n    const bigram = second.substring(i, i + 2);\n    const count = bigrams.has(bigram) ? bigrams.get(bigram) : 0;\n    if (count > 0) {\n      bigrams.set(bigram, count - 1);\n      intersection++;\n    }\n  }\n  return (2.0 * intersection) / (first.length + second.length - 2);\n}\n\n// 4. MATCHING\nlet bestMatch = { name: null, score: 0 };\n\nfor (const item of dbItems) {\n  const score = getSimilarity(cleanInput, item);\n  if (score > bestMatch.score) {\n    bestMatch = { name: item, score: score };\n  }\n}\n\n// 5. DECISÃƒO\nconst isTBCA = bestMatch.score >= THRESHOLD;\nconst rota = isTBCA ? 'TBCA' : 'Manual';\n\nreturn {\n  json: {\n    original: inputFull,\n    match_name: bestMatch.name,     // Nome oficial da TBCA (se achou)\n    match_score: bestMatch.score,\n    rota_decidida: rota             // 'TBCA' ou 'Manual'\n  }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        768,
        432
      ],
      "id": "1e702c30-9553-4cf0-a7dc-c44f2ee98619",
      "name": "Classificador Inteligente"
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 3
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.rota_decidida }}",
                    "rightValue": "TBCA",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "dcca0756-0b39-4594-807c-b3f2ef7aa828"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "TBCA"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 3
                },
                "conditions": [
                  {
                    "id": "650d0abe-82d9-4331-9a52-42bf3390815a",
                    "leftValue": "={{ $json.rota_decidida }}",
                    "rightValue": "Manual",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Manual"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.4,
      "position": [
        992,
        432
      ],
      "id": "c7323bd7-ec32-434d-9521-22ac998eaf00",
      "name": "Switch"
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "{\n  \"text\": \"âœ… Recebido! Processando em background...\"\n}",
        "options": {}
      },
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.5,
      "position": [
        320,
        432
      ],
      "id": "d71a0ed8-b5fe-42ee-91ec-854aee614168",
      "name": "async 1"
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "{\n  \"text\": \"âœ… Recebido! Processando em background...\"\n}",
        "options": {}
      },
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.5,
      "position": [
        320,
        1104
      ],
      "id": "a5e35a33-cc41-4b6c-87a4-95e188b27a7b",
      "name": "async 2"
    }
  ],
  "pinData": {},
  "connections": {
    "Webhook iOS": {
      "main": [
        [
          {
            "node": "Validador de Input",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Validador de Input": {
      "main": [
        [
          {
            "node": "Router Principal",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Router Principal": {
      "main": [
        [
          {
            "node": "async 1",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Tradutor Combo",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "async 2",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Get row(s) in sheet",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Ler DB Alimentos": {
      "main": [
        [
          {
            "node": "Classificador Inteligente",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "IA TBCA": {
      "main": [
        [
          {
            "node": "Validar Resposta TBCA",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Validar Resposta TBCA": {
      "main": [
        [
          {
            "node": "Gravar TBCA",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Gravar TBCA": {
      "main": [
        []
      ]
    },
    "IA Manual": {
      "main": [
        [
          {
            "node": "Validar Manual",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Validar Manual": {
      "main": [
        [
          {
            "node": "Gravar Manual",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Gravar Manual": {
      "main": [
        []
      ]
    },
    "Tradutor Combo": {
      "main": [
        [
          {
            "node": "Atualizar Solver",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Atualizar Solver": {
      "main": [
        [
          {
            "node": "Ler Resultado Solver",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Ler Resultado Solver": {
      "main": [
        [
          {
            "node": "Formatar Resposta",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Formatar Resposta": {
      "main": [
        [
          {
            "node": "Responder",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Limpar Log Manual": {
      "main": [
        [
          {
            "node": "Limpar Log TBCA",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Limpar Log TBCA": {
      "main": [
        [
          {
            "node": "Limpar Dashboard",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Limpar Dashboard": {
      "main": [
        []
      ]
    },
    "Get row(s) in sheet": {
      "main": [
        [
          {
            "node": "Formatar resumo",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Formatar resumo": {
      "main": [
        [
          {
            "node": "Responder",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Classificador Inteligente": {
      "main": [
        [
          {
            "node": "Switch",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Switch": {
      "main": [
        [
          {
            "node": "IA TBCA",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "IA Manual",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "async 1": {
      "main": [
        [
          {
            "node": "Ler DB Alimentos",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "async 2": {
      "main": [
        [
          {
            "node": "Limpar Log Manual",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": true,
  "settings": {
    "executionOrder": "v1",
    "availableInMCP": false,
    "timeSavedMode": "fixed",
    "callerPolicy": "workflowsFromSameOwner",
    "timezone": "America/Sao_Paulo"
  },
  "versionId": "b2284e2c-7a0b-4986-88fa-a9907e6c496f",
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "a403f6552ab12b75896e98d7440abaf247ad96c64d130ded972889fd49ecae35"
  },
  "id": "qBrqpOdekGmTGCoGbDwfo",
  "tags": []
}
